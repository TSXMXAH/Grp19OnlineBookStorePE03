@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Grp19OnlineBookStorePE03.Classes
@using Grp19OnlineBookStorePE03.Data
@using Microsoft.EntityFrameworkCore

@inject Grp19OnlineBookStorePE03Context DbContext
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<OnlineBookStoreUser> UserManager


<style>
    .section {
        width: 90%;
        margin: 40px auto;
    }

        .section h1 {
            margin-bottom: 25px;
        }

    /* GRID LAYOUT */
    .card-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .card-cover {
        height: 200px;
        background: #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 14px;
    }

    .card-info {
        line-height: 1.6;
        margin-bottom: 20px;
    }

    .card-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .btn {
        background: red;
        color: white;
        border: none;
        padding: 10px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
    }
</style>

<!-- ================= BOOK SECTION ================= -->
<div class="section">
    <h1>Top three picks for you!</h1>

    @if (topBooks == null)
    {
        <p>Loading books...</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var book in topBooks)
            {
                <div class="card">
                    <div class="card-cover">Book Cover</div>

                    <div class="card-info">
                        <strong>@book.BookName</strong><br />
                        Author: @book.Author<br />
                        Category: @book.Category<br /><br />
                        <strong>$@book.Price</strong>
                    </div>
                    <div class="card-buttons">
                        <AuthorizeView Roles="User,Admin">
                            <button class="btn" @onclick="() => AddBookToCart(book.Id)">
                                ADD TO CART
                            </button>
                            <button class="btn" @onclick="() => AddBookToWishlist(book.Id)">
                                WISHLIST
                            </button>
                        </AuthorizeView>
                    </div>

                </div>
            }
        </div>
    }
</div>

<!-- ================= MISC SECTION ================= -->
<div class="section">
    <h1>Other cool stuff you might like</h1>

    @if (topMisc == null)
    {
        <p>Loading items...</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var item in topMisc)
            {
                <div class="card">
                    <div class="card-cover">Item Image</div>

                    <div class="card-info">
                        <strong>@item.MiscName</strong><br />
                        Category: @item.Category<br /><br />
                        <strong>$@item.Price</strong>
                    </div>

                    <div class="card-buttons">
                        <AuthorizeView Roles="User,Admin">
                            <button class="btn" @onclick="() => AddMiscToCart(item.Id)">
                                ADD TO CART
                            </button>
                            <button class="btn" @onclick="() => AddMiscToWishlist(item.Id)">
                                WISHLIST
                            </button>
                        </AuthorizeView>
                    </div>

                </div>
            }
        </div>
    }

</div>
@code {
    private List<Book>? topBooks;
    private List<Misc>? topMisc;

    protected override async Task OnInitializedAsync()
    {
        topBooks = await DbContext.Book
            .OrderBy(b => Guid.NewGuid())
            .Take(3)
            .ToListAsync();

        topMisc = await DbContext.Misc
            .OrderBy(m => Guid.NewGuid())
            .Take(3)
            .ToListAsync();
    }
    private async Task<string?> GetUserIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return null;

        return UserManager.GetUserId(user);
    }
    private async Task AddBookToCart(int bookId)
    {
        var userId = await GetUserIdAsync();
        if (userId == null) return;

        var existing = await DbContext.CartItem
            .FirstOrDefaultAsync(c => c.UserId == userId && c.BookId == bookId);

        if (existing != null)
        {
            existing.Quantity++;
        }
        else
        {
            DbContext.CartItem.Add(new CartItem
            {
                UserId = userId,
                BookId = bookId,
                Quantity = 1
            });
        }

        await DbContext.SaveChangesAsync();
    }
    private async Task AddMiscToCart(int miscId)
    {
        var userId = await GetUserIdAsync();
        if (userId == null) return;

        var existing = await DbContext.CartItem
            .FirstOrDefaultAsync(c => c.UserId == userId && c.MiscId == miscId);

        if (existing != null)
        {
            existing.Quantity++;
        }
        else
        {
            DbContext.CartItem.Add(new CartItem
            {
                UserId = userId,
                MiscId = miscId,
                Quantity = 1
            });
        }

        await DbContext.SaveChangesAsync();
    }
    private async Task AddBookToWishlist(int bookId)
    {
        var userId = await GetUserIdAsync();
        if (userId == null) return;

        bool exists = await DbContext.WishlistItem
            .AnyAsync(w => w.UserId == userId && w.BookId == bookId);

        if (exists) return;

        DbContext.WishlistItem.Add(new WishlistItem
        {
            UserId = userId,
            BookId = bookId
        });

        await DbContext.SaveChangesAsync();
    }
    private async Task AddMiscToWishlist(int miscId)
    {
        var userId = await GetUserIdAsync();
        if (userId == null) return;

        bool exists = await DbContext.WishlistItem
            .AnyAsync(w => w.UserId == userId && w.MiscId == miscId);

        if (exists) return;

        DbContext.WishlistItem.Add(new WishlistItem
        {
            UserId = userId,
            MiscId = miscId
        });

        await DbContext.SaveChangesAsync();
    }

}